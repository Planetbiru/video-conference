const peers={};let peerDetails={};const localVideo=document.createElement("video");localVideo.autoplay=!0,localVideo.muted=!0,localVideo.playsInline=!0,localVideo.id="video-local";let reconnectInterval=5e3;const peerConfiguration={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}]};let localStream,clientId;const remoteVideos={},mainScreen=document.getElementById("main-screen"),promoteBtn=document.getElementById("promoteBtn"),wsProtocol="https:"===window.location.protocol?"wss":"ws",wsHost=window.location.hostname,wsPort=3e3;let currentRoomId="default";const urlParams=new URLSearchParams(window.location.search);currentRoomId=urlParams.get("roomId")||"default";let socketUrl=`${wsProtocol}://${wsHost}:3000?roomId=${encodeURIComponent(currentRoomId)}`,socket;const CHUNK_SIZE=16384,incomingFiles={},CLASS_MUTED="muted",CLASS_SHARING="status-sharing",SELECTOR_PROMOTE_STREAM=".btn-promote-stream",SELECTOR_SHARE_CAMERA=".btn-share-camera",SELECTOR_SHARE_SCREEN=".btn-share-screen",SELECTOR_SHARE_MICROPHONE=".btn-share-microphone",MESSAGE_TYPE_STREAM_UPDATE="streamUpdate",MESSAGE_TYPE_OFFER="offer",MESSAGE_TYPE_CANDIDATE="candidate",MESSAGE_TYPE_DEMOTE_STREAM="demoteStream",MESSAGE_TYPE_PROMOTE_STREAM="promoteStream",MESSAGE_TYPE_PEERS="peers",MESSAGE_TYPE_PEAR_LEAVE="pearLeave",MESSAGE_TYPE_STOP_SHARING="stopSharing",MESSAGE_TYPE_CHAT="chat",MESSAGE_TYPE_ANSWER="answer",MESSAGE_TYPE_REQUEST_CHAT_HISTORY="requestChatHistory",MESSAGE_TYPE_CHAT_HISTORY="chatHistory",MESSAGE_TYPE_REQUEST_CHAT_EVENT="requestChatEvent",MESSAGE_TYPE_CHAT_EVENT="chatEvent",MESSAGE_TYPE_FILE_META="fileMeta",MESSAGE_TYPE_FILE_CHUNK="fileChunk",MESSAGE_TYPE_FILE_COMPLETE="fileComplete",MESSAGE_TYPE_FILE_REQUEST="fileRequest",MESSAGE_TYPE_FILE_UPDATE="fileUpdate",MESSAGE_TYPE_NEW_PEAR="newPeer";let controlIcons=[SELECTOR_SHARE_CAMERA,SELECTOR_SHARE_SCREEN,SELECTOR_PROMOTE_STREAM,];function markShareCameraActive(){let e=document.querySelectorAll(SELECTOR_SHARE_CAMERA);e?.length&&e.forEach(e=>{e.classList.add(CLASS_SHARING)})}function markShareCameraInactive(){let e=document.querySelectorAll(SELECTOR_SHARE_CAMERA);e?.length&&e.forEach(e=>{e.classList.remove(CLASS_SHARING)})}function isShareCameraActive(){return Array.from(document.querySelectorAll(SELECTOR_SHARE_CAMERA)).some(e=>e.classList.contains(CLASS_SHARING))}function markShareScreenActive(){let e=document.querySelectorAll(SELECTOR_SHARE_SCREEN);e?.length&&e.forEach(e=>{e.classList.add(CLASS_SHARING)})}function markShareScreenInactive(){return Array.from(document.querySelectorAll(SELECTOR_SHARE_SCREEN)).some(e=>e.classList.contains(CLASS_SHARING))}function isShareScreenActive(){let e=document.querySelectorAll(SELECTOR_SHARE_SCREEN),t=!1;return e?.length&&e.forEach(e=>{if(t=e.classList.contains(CLASS_SHARING))return!0}),!1}function markPromoteStreamActive(){let e=document.querySelectorAll(SELECTOR_PROMOTE_STREAM);e?.length&&e.forEach(e=>{e.classList.add(CLASS_SHARING)})}function markPromoteStramInavtive(){return Array.from(document.querySelectorAll(SELECTOR_PROMOTE_STREAM)).some(e=>e.classList.contains(CLASS_SHARING))}function isPromoteStreamActive(){return Array.from(document.querySelectorAll(SELECTOR_PROMOTE_STREAM)).some(e=>e.classList.contains(CLASS_SHARING))}function isMicrophoneMuted(){return Array.from(document.querySelectorAll(SELECTOR_SHARE_MICROPHONE)).some(e=>e.classList.contains(CLASS_MUTED))}function isMicrophoneActive(){if(!localStream)return!1;let e=localStream.getAudioTracks();return!!e&&0!==e.length&&e.some(e=>e.enabled&&!e.muted)}function toggleMute(e){if(!localStream)return;let t=localStream.getAudioTracks();if(t.length)isMicrophoneMuted()?(console.log("Microphone unmuted"),e&&e.classList.remove(CLASS_MUTED),isShareCameraActive()&&e.classList.add(CLASS_SHARING)):(console.log("Microphone muted"),e&&e.classList.add(CLASS_MUTED),isShareCameraActive()&&e.classList.remove(CLASS_SHARING))}async function startMicrophone(e){if(isShareCameraActive()){toggleMute(e);return}if(console.log("not sahre"),isMicrophoneActive()){await stopMicrophone(),e&&(e.classList.remove(CLASS_SHARING),e.classList.add(CLASS_MUTED));return}try{let t=await navigator.mediaDevices.getUserMedia({audio:!0});localStream?(t.getAudioTracks().forEach(e=>{localStream.addTrack(e)}),localVideo.srcObject=localStream):(localStream=t,localVideo.srcObject=localStream),e&&(e.classList.add(CLASS_SHARING),e.classList.remove(CLASS_MUTED)),await replaceOrAddTracksToPeers(localStream),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),await renegotiateWithPeers(),console.log("Microphone started/added to localStream.")}catch(r){console.error("Failed to start microphone:",r),e&&e.classList.remove(CLASS_SHARING)}}async function stopMicrophone(){if(!localStream)return;let e=localStream.getAudioTracks();for(let[t,r]of(e&&e.length&&e.forEach(e=>{try{e.stop()}catch(t){}try{localStream.removeTrack(e)}catch(r){}}),Object.entries(peers)))try{let a=r.getSenders().filter(e=>e.track&&"audio"===e.track.kind);for(let o of a)try{r.removeTrack(o)}catch(n){}let l=await r.createOffer();await r.setLocalDescription(l),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:l,to:t,from:clientId}))}catch(c){console.warn("stopMicrophone: renegotiate failed for",t,c)}localStream.getTracks()&&0!==localStream.getTracks().length?localVideo.srcObject=localStream:(localStream=null,localVideo.srcObject=null,setMainScreenStream(null)),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),console.log("Microphone stopped/removed from localStream.")}function muteLocalAudio(){if(!localStream)return;let e=localStream.getAudioTracks();e.forEach(e=>{e.enabled=!1}),document.querySelectorAll(".btn-share-microphone").forEach(e=>e.classList.add(CLASS_MUTED)),console.log("Local audio muted (tracks disabled).")}function unmuteLocalAudio(){if(!localStream)return;let e=localStream.getAudioTracks();e.forEach(e=>{e.enabled=!0}),document.querySelectorAll(".btn-share-microphone").forEach(e=>e.classList.remove(CLASS_MUTED)),console.log("Local audio unmuted (tracks enabled).")}async function toggleMuteAudio(e){if(!localStream||!localStream.getAudioTracks()||0===localStream.getAudioTracks().length){await startMicrophone(e);return}let t=localStream.getAudioTracks(),r=t.some(e=>e.enabled);r?(muteLocalAudio(),e&&e.classList.add(CLASS_MUTED)):(unmuteLocalAudio(),e&&e.classList.remove(CLASS_MUTED))}async function removeAudioSendersFromPeers(){for(let[e,t]of Object.entries(peers))try{let r=t.getSenders().filter(e=>e.track&&"audio"===e.track.kind);for(let a of r)try{t.removeTrack(a)}catch(o){}let n=await t.createOffer();await t.setLocalDescription(n),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:n,to:e,from:clientId}))}catch(l){console.warn("removeAudioSendersFromPeers failed for",e,l)}}function switchStreamTo(e){e===clientId?setMainScreenStream(localStream):waitAndAttachToMain(e)}function joinRoom(e){e&&(currentRoomId=e,connectSocket(e))}async function handleOnMessage(e){let t=e.from;if(e.type===MESSAGE_TYPE_CHAT){renderNewChat(e);return}if(e.type===MESSAGE_TYPE_FILE_META){incomingFiles[e.fileId]={meta:e,from:t,chunks:[]},putFilePlaceholder(e);return}if(e.type===MESSAGE_TYPE_FILE_UPDATE){if(e.complete){let r=document.querySelectorAll(`.url-href[data-file-id="${e.fileId}"]`);r&&r.forEach(e=>{e.dataset.complete="true"}),requestCompletedFile()}return}if(e.type===MESSAGE_TYPE_FILE_CHUNK){let a=incomingFiles[e.fileId];if(a){let o=atob(e.data),n=Array(o.length);for(let l=0;l<o.length;l++)n[l]=o.charCodeAt(l);let c=new Uint8Array(n);a.chunks.push(c)}return}if(e.type===MESSAGE_TYPE_FILE_COMPLETE){let i=incomingFiles[e.fileId];if(i){let s=new Blob(i.chunks,{type:i.meta.mimeType}),d=URL.createObjectURL(s),S=document.getElementById("chat-box"),m=document.querySelectorAll(`.url-src[data-file-id="${e.fileId}"]`),E=document.querySelectorAll(`.url-href[data-file-id="${e.fileId}"]`);m&&m.forEach(e=>{e.setAttribute("src",d),e.dataset.loaded="true"}),E&&E.forEach(e=>{e.setAttribute("href",d),e.dataset.loaded="true"}),S.scrollTop=S.scrollHeight,delete incomingFiles[e.fileId]}return}if("chatHistory"===e.type){putChatHistory(e.chatHistory),loadMissedFiles();return}if("chatEvent"===e.type){e.chatEvent&&e.chatEvent.forEach(e=>handleOnMessage(e));return}if(e.type===MESSAGE_TYPE_PROMOTE_STREAM){document.querySelector("#promoteBtn").classList.remove(CLASS_SHARING);let f=document.querySelector(`input[name="mainStreamSelector"][value="${e.from}"]`);if(!f){console.error("Please select a stream first");return}f.checked=!0;let u="local"===f.value?clientId:f.value;switchStreamTo(u);return}if(e.type===MESSAGE_TYPE_DEMOTE_STREAM){let p=document.querySelector('input[name="mainStreamSelector"][value="local"]');if(!p){console.error("Please select a stream first");return}p.checked=!0;let A="local"===p.value?clientId:p.value;switchStreamTo(A);return}if(e.type===MESSAGE_TYPE_STREAM_UPDATE){ensureRemoteVideoElement(e.from);let h=document.querySelector('input[name="mainStreamSelector"]:checked');h&&h.value===e.from&&waitAndAttachToMain(e.from);return}if(e.type===MESSAGE_TYPE_STOP_SHARING){console.log(`Received stopSharing from peer: ${e.from}`);let T=document.querySelector(`.video-wrapper[data-peer-id="${e.from}"]`);if(T){let y=T.querySelector("video");y&&(y.srcObject=null,y.style.backgroundColor="black")}return}if(!e.to||e.to===clientId){if("peers"===e.type){clientId=e.myId,promoteBtn&&(promoteBtn.disabled=!1),e.peers.forEach(e=>ensureRemoteVideoElement(e)),e.peers.forEach(e=>{clientId<e&&createOffer(e)});return}if("newPeer"===e.type){ensureRemoteVideoElement(e.peerId),updatePeer(e.peerId,e.peerDetail),clientId<e.peerId&&createOffer(e.peerId);return}if(e.type===MESSAGE_TYPE_OFFER){let g=createPeer(e.from);await g.setRemoteDescription(new RTCSessionDescription(e.offer));let I=await g.createAnswer();await g.setLocalDescription(I),socket.send(JSON.stringify({type:MESSAGE_TYPE_ANSWER,answer:I,to:e.from,from:clientId}));return}if(e.type===MESSAGE_TYPE_ANSWER){peers[e.from]&&await peers[e.from].setRemoteDescription(new RTCSessionDescription(e.answer));return}if(e.type===MESSAGE_TYPE_CANDIDATE){if(peers[e.from])try{await peers[e.from].addIceCandidate(new RTCIceCandidate(e.candidate))}catch(M){console.warn("addIceCandidate failed",M)}return}if("pearLeave"===e.type){peers[e.peerId]&&(peers[e.peerId].close(),delete peers[e.peerId],delete peerDetails[e.peerId]),remoteVideos[e.peerId]&&(remoteVideos[e.peerId].wrapper.remove(),delete remoteVideos[e.peerId]),mainScreen.srcObject&&isSameStream(mainScreen.srcObject,remoteVideos[e.peerId]?.video?.srcObject)&&setMainScreenStream(localStream||null);return}}}function connectSocket(e){socket&&socket.readyState===WebSocket.OPEN&&socket.close(),socketUrl=`${wsProtocol}://${wsHost}:3000?roomId=${encodeURIComponent(e)}`,(socket=new WebSocket(socketUrl)).onopen=()=>{setupLocalVideo(),requestChatHistory(),requestChatEvent()},socket.onmessage=async({data:e})=>{let t=JSON.parse(e);handleOnMessage(t)},socket.onclose=()=>{console.warn("Socket closed. Reconnecting..."),setTimeout(()=>{connectSocket(currentRoomId)},reconnectInterval)},socket.onerror=e=>{console.error("Socket error:",e),socket.close()}}function putHistoryChat(e){e.type===MESSAGE_TYPE_CHAT?renderNewChat(e):e.type===MESSAGE_TYPE_FILE_META&&putFilePlaceholder(e)}function putFilePlaceholder(e){let t=document.getElementById("chat-box"),r=document.createElement("div");r.classList.add("chat-container");let a=document.createElement("div");a.classList.add("chat-sender"),a.textContent=`${e.from}`,r.appendChild(a);let o=document.createElement("div");o.classList.add("file-container"),o.id=`file-${e.fileId}`;let n=e.realtime?"true":"false",l=e.complete?"true":"false";if(e.mimeType.startsWith("image/")){let c=document.createElement("div");c.classList.add("image-received");let i=document.createElement("img");i.classList.add("url-src"),i.src="image.svg",i.alt=e.name,i.dataset.fileId=e.fileId,i.dataset.realtime=n,i.dataset.complete=l,i.dataset.loaded="false",i.dataset.process="false",c.appendChild(i),o.appendChild(c)}let s=document.createElement("a");s.classList.add("url-href"),s.href="#",s.download=e.name,s.dataset.fileId=e.fileId,s.dataset.realtime=n,s.dataset.complete=l,s.dataset.loaded="false",s.dataset.process="false",s.textContent=`📎 ${e.name}`;let d=document.createElement("div");d.classList.add("file-name-container"),d.appendChild(s),o.appendChild(d),r.appendChild(o),t.appendChild(r),requestCompletedFile(),requestIncompletedFile()}let isMissedFilesLoaded=!1;function loadMissedFiles(){!isMissedFilesLoaded&&(requestCompletedFile(),checkInterval=setInterval(()=>{requestIncompletedFile()},5e3),isMissedFilesLoaded=!0)}let checkInterval=setInterval("",1e5);function requestIncompletedFile(){let e=document.querySelectorAll('.url-href[data-realtime="false"][data-complete="false"][data-loaded="false"]');e?e.forEach(e=>{socket.send(JSON.stringify({type:MESSAGE_TYPE_FILE_UPDATE,from:clientId,fileId:e.dataset.fileId}))}):(clearTimeout(checkInterval),isMissedFilesLoaded=!1)}function requestCompletedFile(){let e=document.querySelectorAll('.url-href[data-realtime="false"][data-complete="true"][data-loaded="false"]');e&&e.forEach(e=>{socket.send(JSON.stringify({type:"fileRequest",from:clientId,fileId:e.dataset.fileId})),e.dataset.process="true"})}function renderNewChat(e){let t=document.getElementById("chat-box"),r=document.createElement("div");r.classList.add("chat-container");let a=document.createElement("div");a.classList.add("chat-sender"),a.textContent=e.from,r.appendChild(a);let o=document.createElement("div");o.classList.add("chat-content"),o.textContent=e.text,r.appendChild(o),t.appendChild(r),setTimeout(()=>{let e=document.querySelector(".chat-box-container");e&&(e.scrollTop=e.scrollHeight)},100)}function putChatHistory(e){e.forEach(e=>putHistoryChat(e))}function updatePeer(e,t){peerDetails[e]=t}function requestChatHistory(){socket.send(JSON.stringify({type:"requestChatHistory",from:clientId}))}function requestChatEvent(){socket.send(JSON.stringify({type:"requestChatEvent",from:clientId}))}function isSameStream(e,t){return e===t}function setMainScreenStream(e){if(mainScreen){if(!e){mainScreen.srcObject=null;return}mainScreen.srcObject=e,mainScreen.muted=!0,mainScreen.playsInline=!0,mainScreen.play().catch(e=>{console.warn("Main screen play() blocked or failed:",e)})}}function setMainScreenLocal(){localStream?(setMainScreenStream(localStream),console.log("Main screen set to local stream")):console.warn("No localStream available yet")}function setupLocalVideo(){let e=document.createElement("div");e.className="video-wrapper";let t=document.createElement("div");t.className="video-controls";let r=document.createElement("input");r.type="radio",r.name="mainStreamSelector",r.value="local",r.id="radio-local",r.checked=!0,r.addEventListener("change",()=>{r.checked&&setMainScreenLocal()});let a=document.createElement("label");a.htmlFor="radio-local",a.textContent=" My Stream",t.appendChild(r),t.appendChild(a),e.appendChild(localVideo),e.appendChild(t),document.getElementById("video-container").appendChild(e)}function createPeer(e){if(peers[e])return peers[e];let t=new RTCPeerConnection(peerConfiguration);return peers[e]=t,localStream&&localStream.getTracks().forEach(e=>t.addTrack(e,localStream)),t.onicecandidate=t=>{t.candidate&&socket.send(JSON.stringify({type:MESSAGE_TYPE_CANDIDATE,candidate:t.candidate,to:e,from:clientId}))},t.ontrack=t=>{console.log("ontrack from",e,t.streams[0]),ensureRemoteVideoElement(e);let r=remoteVideos[e].video;r.srcObject=t.streams[0];let a=document.querySelector('input[name="mainStreamSelector"]:checked');a&&a.value===e&&waitAndAttachToMain(e)},t}async function createOffer(e){let t=createPeer(e),r=await t.createOffer();await t.setLocalDescription(r),socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:r,to:e,from:clientId}))}function ensureRemoteVideoElement(e){if(remoteVideos[e])return remoteVideos[e];let t=document.createElement("div");t.className="video-wrapper",t.dataset.peerId=e,t.style.minWidth="160px";let r=document.createElement("video");r.autoplay=!0,r.playsInline=!0,r.id=`video-${e}`;let a=document.createElement("div");a.className="video-controls";let o=document.createElement("input");o.type="radio",o.name="mainStreamSelector",o.value=e,o.id=`radio-${e}`,o.addEventListener("change",()=>{o.checked&&waitAndAttachToMain(e)});let n=document.createElement("label");return n.htmlFor=`radio-${e}`,n.textContent=` Participant (${e?.substring(0,4)})`,a.appendChild(o),a.appendChild(n),t.appendChild(r),t.appendChild(a),document.getElementById("video-container").appendChild(t),remoteVideos[e]={wrapper:t,video:r},remoteVideos[e]}function waitAndAttachToMain(e,t=5e3){if(e===clientId){setMainScreenStream(localStream);return}let r=remoteVideos[e];r||(console.log("No video element for",e,"— creating placeholder."),ensureRemoteVideoElement(e));let a=remoteVideos[e].video;if(a.srcObject&&a.readyState>=2){setMainScreenStream(a.srcObject),console.log("Attached immediately main screen from",e);return}let o=!1,n=()=>{o||(o=!0,setMainScreenStream(a.srcObject),l(),console.log("Attached main screen after event from",e))},l=()=>{a.removeEventListener("loadedmetadata",n),a.removeEventListener("playing",n),clearTimeout(c)};a.addEventListener("loadedmetadata",n),a.addEventListener("playing",n);let c=setTimeout(()=>{o||(l(),console.warn(`Timeout waiting for video of ${e} to become ready.`))},t)}function isAudioMuted(){return document.querySelector(SELECTOR_SHARE_MICROPHONE).classList.contains(CLASS_MUTED)}async function startCamera(e){if(e.classList.contains(CLASS_SHARING)){e.classList.remove(CLASS_SHARING),stopSharing();return}try{localStream&&localStream.getTracks().forEach(e=>e.stop()),localStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),localVideo.srcObject=localStream,setMainScreenStream(localStream);let t=document.getElementById("radio-local");t&&(t.checked=!0),console.log("Local camera stream started."),e&&e.classList.add(CLASS_SHARING),isAudioMuted()&&muteLocalAudio(),await replaceOrAddTracksToPeers(localStream),socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),await renegotiateWithPeers()}catch(r){console.error("Failed to get local stream:",r),e&&e.classList.remove(CLASS_SHARING)}}async function shareScreen(e){if(e.classList.contains(CLASS_SHARING)){e.classList.remove(CLASS_SHARING),stopSharing();return}try{let t=await navigator.mediaDevices.getDisplayMedia({video:!0}),r=t.getVideoTracks()[0];localStream&&localStream.getVideoTracks().forEach(e=>e.stop()),localStream=t,localVideo.srcObject=localStream,setMainScreenStream(localStream);let a=document.getElementById("radio-local");a&&(a.checked=!0),console.log("Screen sharing started."),e&&e.classList.add(CLASS_SHARING),await replaceOrAddTracksToPeers(localStream),r.onended=async()=>{e&&e.classList.remove(CLASS_SHARING),await startCamera(e)},socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),await renegotiateWithPeers()}catch(o){console.error("Failed to share screen:",o),e&&e.classList.remove(CLASS_SHARING)}}async function replaceOrAddTracksToPeers(e){await Promise.all(Object.entries(peers).map(async([t,r])=>{for(let a of e.getTracks()){let o=r.getSenders().find(e=>e.track&&e.track.kind===a.kind);if(o)try{await o.replaceTrack(a)}catch(n){try{r.removeTrack(o)}catch(l){}r.addTrack(a,e)}else r.addTrack(a,e)}}))}async function renegotiateWithPeers(){for(let[e,t]of Object.entries(peers))try{let r=await t.createOffer();await t.setLocalDescription(r),socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:r,to:e,from:clientId}))}catch(a){console.warn("Renegotiate failed for",e,a)}}function sendChat(){let e=document.getElementById("chatInput").value;if(!e.trim())return;document.getElementById("chatInput").value="";let t={type:MESSAGE_TYPE_CHAT,text:e,from:clientId,messageId:generateMessageId()};renderNewChat(t),socket.send(JSON.stringify(t))}function generateMessageId(){return crypto&&crypto.randomUUID?crypto.randomUUID():"msg-"+Date.now()+"-"+Math.floor(1e6*Math.random())}function promoteMyStream(e){if(e.classList.contains(CLASS_SHARING)){e.classList.remove(CLASS_SHARING),demoteMyStream();return}e.classList.add(CLASS_SHARING),socket.send(JSON.stringify({type:MESSAGE_TYPE_PROMOTE_STREAM,from:clientId,eventId:generateNewId()}));let t=document.querySelector('input[name="mainStreamSelector"][value="local"]');if(!t){console.error("Please select a stream first");return}t.checked=!0;let r="local"===t.value?clientId:t.value;switchStreamTo(r)}function demoteMyStream(){socket.send(JSON.stringify({type:MESSAGE_TYPE_DEMOTE_STREAM,from:clientId,eventId:generateNewId()}))}function promoteSelected(){if(!clientId){console.error("Client ID not ready");return}let e=document.querySelector('input[name="mainStreamSelector"]:checked');if(!e){console.error("Please select a stream first");return}let t="local"===e.value?clientId:e.value;switchStreamTo(t),socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId}))}async function replaceOrAddTracksToPeers(e){await Promise.all(Object.entries(peers).map(async([t,r])=>{for(let a of e.getTracks()){let o=r.getSenders().find(e=>e.track&&e.track.kind===a.kind);o?await o.replaceTrack(a):r.addTrack(a,e)}}))}async function stopSharing(){try{if(localStream){localStream.getVideoTracks().forEach(e=>e.stop());let e=localStream.getAudioTracks();localStream=e.length?new MediaStream(e):null}for(let[t,r]of(localVideo.srcObject=null,setMainScreenStream(null),console.log("Stopped sharing local video."),socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId,eventId:generateNewId()})),socket.send(JSON.stringify({type:MESSAGE_TYPE_DEMOTE_STREAM,from:clientId,eventId:generateNewId()})),socket.send(JSON.stringify({type:MESSAGE_TYPE_STOP_SHARING,from:clientId,eventId:generateNewId()})),document.querySelector("#promoteBtn").classList.remove(CLASS_SHARING),Object.entries(peers))){let a=r.getSenders().filter(e=>e.track&&"video"===e.track.kind);a.forEach(e=>{try{r.removeTrack(e)}catch(t){}});try{let o=await r.createOffer();await r.setLocalDescription(o),socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:o,to:t,from:clientId}))}catch(n){console.warn("Renegotiate failed on stopSharing for",t,n)}}}catch(l){console.error("Failed to stop sharing:",l)}}function arrayBufferToBase64(e){let t="",r=new Uint8Array(e),a=r.byteLength;for(let o=0;o<a;o++)t+=String.fromCharCode(r[o]);return btoa(t)}function generateFileId(){return window.crypto?.randomUUID?crypto.randomUUID():"file-"+Date.now()+"-"+Math.floor(1e5*Math.random())}function getFileExtension(e){let t=e.split(".");return t.length>1?t.pop().toLowerCase():""}async function sendFile(){let e=document.getElementById("fileInput"),t=e.files[0];if(!t)return;let r=generateFileId(),a={type:MESSAGE_TYPE_FILE_META,fileId:r,name:t.name,extension:getFileExtension(t.name),size:t.size,mimeType:t.type,from:clientId,realtime:!0,complete:!1,chunkSize:16384};socket.send(JSON.stringify(a));let o=0;for(;o<t.size;){let n=t.slice(o,o+16384),l=await n.arrayBuffer(),c=arrayBufferToBase64(l);socket.send(JSON.stringify({type:MESSAGE_TYPE_FILE_CHUNK,fileId:r,name:t.name,extension:getFileExtension(t.name),from:clientId,offset:o,chunkSize:16384,data:c})),o+=16384}socket.send(JSON.stringify({type:MESSAGE_TYPE_FILE_COMPLETE,fileId:r,from:clientId})),clearFile();let i=document.getElementById("chat-box"),s=document.createElement("div"),d=URL.createObjectURL(t);t.type.startsWith("image/")?s.innerHTML=`<strong>You:</strong><br>
                        <div class="image-received">
                          <img src="${d}" alt="${t.name}">
                        </div>
                        <a href="${d}" download="${t.name}">📎 ${t.name}</a>`:s.innerHTML=`<strong>You:</strong> 
                         <a href="${d}" download="${t.name}">📎 ${t.name}</a>`,i.appendChild(s),setTimeout(function(){document.querySelector(".chat-box-container").scrollTop=document.querySelector(".chat-box-container").scrollHeight},100)}function selectFile(){document.getElementById("fileInput").click()}function previewFile(){let e=document.getElementById("fileInput"),t=document.querySelector(".send-file-preview");if(t.innerHTML="",0===e.files.length)return;let r=e.files[0],a=r.name,o=document.createElement("div");o.classList.add("flex","items-center","gap-2","bg-gray-700","text-white","p-2","rounded","flex-col");let n="";if(r.type.startsWith("image/")){let l=URL.createObjectURL(r);n=`<img src="${l}" alt="${a}" style="max-width:150px; max-height:150px; margin-bottom:4px; border-radius:4px;">`}o.innerHTML=`
        ${n}
        <div class="flex gap-2">
            <span>${a}</span>
            <button type="button" class="px-2 py-1 bg-red-600 rounded" onclick="clearFile()">❌</button>
            <button type="button" class="px-2 py-1 bg-green-600 rounded" onclick="sendFile()">✅</button>
        </div>
    `,t.appendChild(o),setTimeout(function(){document.querySelector(".chat-box-container").scrollTop=document.querySelector(".chat-box-container").scrollHeight},100)}function clearFile(){let e=document.getElementById("fileInput");e.value="",document.querySelector(".send-file-preview").innerHTML=""}function generateNewId(){let e=Date.now().toString(16);e.length%2==1&&(e="0"+e);let t=Math.floor(16777215*Math.random()).toString(16).padStart(6,"0");return e+t}document.addEventListener("DOMContentLoaded",()=>{connectSocket(currentRoomId)});