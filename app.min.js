const peers={};let peerDetails={};const localVideo=document.createElement("video");localVideo.autoplay=!0,localVideo.muted=!0,localVideo.playsInline=!0,localVideo.id="video-local";let reconnectInterval=5e3,localStream,clientId;const remoteVideos={},mainScreen=document.getElementById("main-screen"),promoteBtn=document.getElementById("promoteBtn"),wsProtocol="https:"===window.location.protocol?"wss":"ws",wsHost=window.location.hostname,wsPort=3e3;let currentRoomId="default",socketUrl=`${wsProtocol}://${wsHost}:3000?roomId=${encodeURIComponent(currentRoomId)}`,socket;const CHUNK_SIZE=16384,incomingFiles={},CLASS_MUTED="muted",CLASS_SHARING="status-sharing",SELECTOR_PROMOTE_STREAM=".btn-promote-stream",SELECTOR_SHARE_CAMERA=".btn-share-camera",SELECTOR_SHARE_SCREEN=".btn-share-screen",SELECTOR_SHARE_MICROPHONE=".btn-share-microphone",MESSAGE_TYPE_STREAM_UPDATE="streamUpdate",MESSAGE_TYPE_OFFER="offer",MESSAGE_TYPE_CANDIDATE="candidate",MESSAGE_TYPE_DEMOTE_STREAM="demoteStream",MESSAGE_TYPE_PROMOTE_STREAM="promoteStream",MESSAGE_TYPE_PEERS="peers",MESSAGE_TYPE_PEAR_LEAVE="pearLeave",MESSAGE_TYPE_STOP_SHARING="stopSharing",MESSAGE_TYPE_CHAT="chat",MESSAGE_TYPE_ANSWER="answer",MESSAGE_TYPE_REQUEST_CHAT_HISTORY="requestChatHistory",MESSAGE_TYPE_FILE_META="fileMeta",MESSAGE_TYPE_FILE_CHUNK="fileChunk",MESSAGE_TYPE_FILE_COMPLETE="fileComplete",MESSAGE_TYPE_FILE_REQUEST="fileRequest",MESSAGE_TYPE_FILE_UPDATE="fileUpdate",MESSAGE_TYPE_NEW_PEAR="newPeer";let controlIcons=[SELECTOR_SHARE_CAMERA,SELECTOR_SHARE_SCREEN,SELECTOR_PROMOTE_STREAM,];function markShareCameraActive(){let e=document.querySelectorAll(SELECTOR_SHARE_CAMERA);e?.length&&e.forEach(e=>{e.classList.add(CLASS_SHARING)})}function markShareCameraInactive(){let e=document.querySelectorAll(SELECTOR_SHARE_CAMERA);e?.length&&e.forEach(e=>{e.classList.remove(CLASS_SHARING)})}function isShareCameraActive(){return Array.from(document.querySelectorAll(SELECTOR_SHARE_CAMERA)).some(e=>e.classList.contains(CLASS_SHARING))}function markShareScreenActive(){let e=document.querySelectorAll(SELECTOR_SHARE_SCREEN);e?.length&&e.forEach(e=>{e.classList.add(CLASS_SHARING)})}function markShareScreenInactive(){return Array.from(document.querySelectorAll(SELECTOR_SHARE_SCREEN)).some(e=>e.classList.contains(CLASS_SHARING))}function isShareScreenActive(){let e=document.querySelectorAll(SELECTOR_SHARE_SCREEN),t=!1;return e?.length&&e.forEach(e=>{if(t=e.classList.contains(CLASS_SHARING))return!0}),!1}function markPromoteStreamActive(){let e=document.querySelectorAll(SELECTOR_PROMOTE_STREAM);e?.length&&e.forEach(e=>{e.classList.add(CLASS_SHARING)})}function markPromoteStramInavtive(){return Array.from(document.querySelectorAll(SELECTOR_PROMOTE_STREAM)).some(e=>e.classList.contains(CLASS_SHARING))}function isPromoteStreamActive(){return Array.from(document.querySelectorAll(SELECTOR_PROMOTE_STREAM)).some(e=>e.classList.contains(CLASS_SHARING))}function isMicrophoneMuted(){return Array.from(document.querySelectorAll(SELECTOR_SHARE_MICROPHONE)).some(e=>e.classList.contains(CLASS_MUTED))}function isMicrophoneActive(){if(!localStream)return!1;let e=localStream.getAudioTracks();return!!e&&0!==e.length&&e.some(e=>e.enabled&&!e.muted)}function toggleMute(e){if(!localStream)return;let t=localStream.getAudioTracks();if(t.length)isMicrophoneMuted()?(console.log("Microphone unmuted"),e&&e.classList.remove(CLASS_MUTED),isShareCameraActive()&&e.classList.add(CLASS_SHARING)):(console.log("Microphone muted"),e&&e.classList.add(CLASS_MUTED),isShareCameraActive()&&e.classList.remove(CLASS_SHARING))}async function startMicrophone(e){if(isShareCameraActive()){toggleMute(e);return}if(console.log("not sahre"),isMicrophoneActive()){await stopMicrophone(),e&&(e.classList.remove(CLASS_SHARING),e.classList.add(CLASS_MUTED));return}try{let t=await navigator.mediaDevices.getUserMedia({audio:!0});localStream?(t.getAudioTracks().forEach(e=>{localStream.addTrack(e)}),localVideo.srcObject=localStream):(localStream=t,localVideo.srcObject=localStream),e&&(e.classList.add(CLASS_SHARING),e.classList.remove(CLASS_MUTED)),await replaceOrAddTracksToPeers(localStream),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),await renegotiateWithPeers(),console.log("Microphone started/added to localStream.")}catch(r){console.error("Failed to start microphone:",r),e&&e.classList.remove(CLASS_SHARING)}}async function stopMicrophone(){if(!localStream)return;let e=localStream.getAudioTracks();for(let[t,r]of(e&&e.length&&e.forEach(e=>{try{e.stop()}catch(t){}try{localStream.removeTrack(e)}catch(r){}}),Object.entries(peers)))try{let a=r.getSenders().filter(e=>e.track&&"audio"===e.track.kind);for(let o of a)try{r.removeTrack(o)}catch(l){}let i=await r.createOffer();await r.setLocalDescription(i),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:i,to:t,from:clientId}))}catch(c){console.warn("stopMicrophone: renegotiate failed for",t,c)}localStream.getTracks()&&0!==localStream.getTracks().length?localVideo.srcObject=localStream:(localStream=null,localVideo.srcObject=null,setMainScreenStream(null)),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),console.log("Microphone stopped/removed from localStream.")}function muteLocalAudio(){if(!localStream)return;let e=localStream.getAudioTracks();e.forEach(e=>{e.enabled=!1}),document.querySelectorAll(".btn-share-microphone").forEach(e=>e.classList.add(CLASS_MUTED)),console.log("Local audio muted (tracks disabled).")}function unmuteLocalAudio(){if(!localStream)return;let e=localStream.getAudioTracks();e.forEach(e=>{e.enabled=!0}),document.querySelectorAll(".btn-share-microphone").forEach(e=>e.classList.remove(CLASS_MUTED)),console.log("Local audio unmuted (tracks enabled).")}async function toggleMuteAudio(e){if(!localStream||!localStream.getAudioTracks()||0===localStream.getAudioTracks().length){await startMicrophone(e);return}let t=localStream.getAudioTracks(),r=t.some(e=>e.enabled);r?(muteLocalAudio(),e&&e.classList.add(CLASS_MUTED)):(unmuteLocalAudio(),e&&e.classList.remove(CLASS_MUTED))}async function removeAudioSendersFromPeers(){for(let[e,t]of Object.entries(peers))try{let r=t.getSenders().filter(e=>e.track&&"audio"===e.track.kind);for(let a of r)try{t.removeTrack(a)}catch(o){}let l=await t.createOffer();await t.setLocalDescription(l),socket&&socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:l,to:e,from:clientId}))}catch(i){console.warn("removeAudioSendersFromPeers failed for",e,i)}}function switchStreamTo(e){e===clientId?setMainScreenStream(localStream):waitAndAttachToMain(e)}function joinRoom(e){e&&(currentRoomId=e,connectSocket(e))}function connectSocket(e){socket&&socket.readyState===WebSocket.OPEN&&socket.close(),socketUrl=`${wsProtocol}://${wsHost}:3000?roomId=${encodeURIComponent(e)}`,(socket=new WebSocket(socketUrl)).onopen=()=>{setupLocalVideo(),requestChatHistory()},socket.onmessage=async({data:e})=>{let t=JSON.parse(e);console.log(t.type);let r=t.from;if(t.type===MESSAGE_TYPE_CHAT){putChat(t);return}if(t.type===MESSAGE_TYPE_FILE_META){incomingFiles[t.fileId]={meta:t,from:r,chunks:[]},putFilePlaceholder(t);return}if(t.type===MESSAGE_TYPE_FILE_UPDATE){if(t.complete){let a=document.querySelectorAll(`.url-href[data-file-id="${t.fileId}"]`);a&&a.forEach(e=>{e.dataset.complete="true"}),requestCompletedFile()}return}if(t.type===MESSAGE_TYPE_FILE_CHUNK){let o=incomingFiles[t.fileId];if(o){let l=atob(t.data),i=Array(l.length);for(let c=0;c<l.length;c++)i[c]=l.charCodeAt(c);let n=new Uint8Array(i);o.chunks.push(n)}return}if(t.type===MESSAGE_TYPE_FILE_COMPLETE){let s=incomingFiles[t.fileId];if(s){let d=new Blob(s.chunks,{type:s.meta.mimeType}),S=URL.createObjectURL(d),m=document.getElementById("chat-box"),E=document.querySelectorAll(`.url-src[data-file-id="${t.fileId}"]`),f=document.querySelectorAll(`.url-href[data-file-id="${t.fileId}"]`);E&&E.forEach(e=>{e.setAttribute("src",S),e.dataset.loaded="true"}),f&&f.forEach(e=>{e.setAttribute("href",S),e.dataset.loaded="true"}),m.scrollTop=m.scrollHeight,delete incomingFiles[t.fileId]}return}if("chatHistory"===t.type){console.log("putChatHistory"),putChatHistory(t.chatHistory),loadMissedFiles();return}if(t.type===MESSAGE_TYPE_PROMOTE_STREAM){document.querySelector("#promoteBtn").classList.remove(CLASS_SHARING);let u=document.querySelector(`input[name="mainStreamSelector"][value="${t.from}"]`);if(!u){console.error("Please select a stream first");return}u.checked=!0;let p="local"===u.value?clientId:u.value;switchStreamTo(p);return}if(t.type===MESSAGE_TYPE_DEMOTE_STREAM){let A=document.querySelector('input[name="mainStreamSelector"][value="local"]');if(!A){console.error("Please select a stream first");return}A.checked=!0;let h="local"===A.value?clientId:A.value;switchStreamTo(h);return}if(t.type===MESSAGE_TYPE_STREAM_UPDATE){ensureRemoteVideoElement(t.from);let T=document.querySelector('input[name="mainStreamSelector"]:checked');T&&T.value===t.from&&waitAndAttachToMain(t.from);return}if(t.type===MESSAGE_TYPE_STOP_SHARING){console.log(`Received stopSharing from peer: ${t.from}`);let y=document.querySelector(`.video-wrapper[data-peer-id="${t.from}"]`);if(y){let g=y.querySelector("video");g&&(g.srcObject=null,g.style.backgroundColor="black")}return}if(!t.to||t.to===clientId){if("peers"===t.type){clientId=t.myId,promoteBtn&&(promoteBtn.disabled=!1),t.peers.forEach(e=>ensureRemoteVideoElement(e)),t.peers.forEach(e=>{clientId<e&&createOffer(e)});return}if("newPeer"===t.type){ensureRemoteVideoElement(t.peerId),updatePeer(t.peerId,t.peerDetail),clientId<t.peerId&&createOffer(t.peerId);return}if(t.type===MESSAGE_TYPE_OFFER){let I=createPeer(t.from);await I.setRemoteDescription(new RTCSessionDescription(t.offer));let M=await I.createAnswer();await I.setLocalDescription(M),socket.send(JSON.stringify({type:MESSAGE_TYPE_ANSWER,answer:M,to:t.from,from:clientId}));return}if(t.type===MESSAGE_TYPE_ANSWER){peers[t.from]&&await peers[t.from].setRemoteDescription(new RTCSessionDescription(t.answer));return}if(t.type===MESSAGE_TYPE_CANDIDATE){if(peers[t.from])try{await peers[t.from].addIceCandidate(new RTCIceCandidate(t.candidate))}catch(L){console.warn("addIceCandidate failed",L)}return}if("pearLeave"===t.type){peers[t.peerId]&&(peers[t.peerId].close(),delete peers[t.peerId],delete peerDetails[t.peerId]),remoteVideos[t.peerId]&&(remoteVideos[t.peerId].wrapper.remove(),delete remoteVideos[t.peerId]),mainScreen.srcObject&&isSameStream(mainScreen.srcObject,remoteVideos[t.peerId]?.video?.srcObject)&&setMainScreenStream(localStream||null);return}}},socket.onclose=()=>{console.warn("Socket closed. Reconnecting..."),setTimeout(connectSocket,reconnectInterval)},socket.onerror=e=>{console.error("Socket error:",e),socket.close()}}function putHistoryChat(e){e.type===MESSAGE_TYPE_CHAT?putChat(e):e.type===MESSAGE_TYPE_FILE_META&&putFilePlaceholder(e)}function putFilePlaceholder(e){if(console.log("putFilePlaceholder"),console.log("Dipanggil oleh:",putFilePlaceholder.caller.name),document.querySelector(`.url-src[data-file-id="${e.fileId}"]`))return;let t=document.getElementById("chat-box"),r=document.createElement("div"),a=e.realtime?"true":"false",o=e.complete?"true":"false";e?.mimeType?.startsWith("image/")?r.innerHTML=`<strong>${e.from}:</strong><br>
        <div class="image-received">
        <img data-file-id="${e.fileId}" data-realtime="${a}" data-complete="${o}" data-loaded="false" data-process="false" class="url-src" src="image.svg" alt="${e.name}">
        </div>
        <a data-file-id="${e.fileId}" data-realtime="${a}" data-complete="${o}" data-loaded="false" data-process="false" class="url-href" href="image.svg" download="${e.name}">📎 ${e.name}</a>`:r.innerHTML=`<strong>${e.from}:</strong> 
        <a data-file-id="${e.fileId}" data-realtime="${a}" data-complete="${o}" data-loaded="false" data-process="false" class="url-href" href="image.svg" download="${e.name}">
            📎 ${e.name}
        </a>`,t.appendChild(r)}let isMissedFilesLoaded=!1;function loadMissedFiles(){!isMissedFilesLoaded&&(requestCompletedFile(),checkInterval=setInterval(()=>{requestIncompletedFile()},5e3),isMissedFilesLoaded=!0)}let checkInterval=setInterval("",1e5);function requestIncompletedFile(){let e=document.querySelectorAll('.url-href[data-realtime="false"][data-complete="false"][data-loaded="false"]');e?e.forEach(e=>{socket.send(JSON.stringify({type:MESSAGE_TYPE_FILE_UPDATE,from:clientId,fileId:e.dataset.fileId}))}):(clearTimeout(checkInterval),isMissedFilesLoaded=!1)}function requestCompletedFile(){let e=document.querySelectorAll('.url-href[data-realtime="false"][data-complete="true"][data-loaded="false"]');e&&e.forEach(e=>{socket.send(JSON.stringify({type:"fileRequest",from:clientId,fileId:e.dataset.fileId})),e.dataset.process="true"})}function putChat(e){let t=document.getElementById("chat-box");t.innerHTML+=`\r
<div><strong>${e.from}:</strong> ${e.text}</div>`,setTimeout(function(){document.querySelector(".chat-box-container").scrollTop=document.querySelector(".chat-box-container").scrollHeight},100)}function putChatHistory(e){e.forEach(e=>putHistoryChat(e))}function updatePeer(e,t){peerDetails[e]=t}function requestChatHistory(){socket.send(JSON.stringify({type:"requestChatHistory",from:clientId}))}function isSameStream(e,t){return e===t}function setMainScreenStream(e){if(mainScreen){if(!e){mainScreen.srcObject=null;return}mainScreen.srcObject=e,mainScreen.muted=!0,mainScreen.playsInline=!0,mainScreen.play().catch(e=>{console.warn("Main screen play() blocked or failed:",e)})}}function setMainScreenLocal(){localStream?(setMainScreenStream(localStream),console.log("Main screen set to local stream")):console.warn("No localStream available yet")}function setupLocalVideo(){let e=document.createElement("div");e.className="video-wrapper";let t=document.createElement("div");t.className="video-controls";let r=document.createElement("input");r.type="radio",r.name="mainStreamSelector",r.value="local",r.id="radio-local",r.checked=!0,r.addEventListener("change",()=>{r.checked&&setMainScreenLocal()});let a=document.createElement("label");a.htmlFor="radio-local",a.textContent=" My Stream",t.appendChild(r),t.appendChild(a),e.appendChild(localVideo),e.appendChild(t),document.getElementById("video-container").appendChild(e)}function createPeer(e){if(peers[e])return peers[e];let t=new RTCPeerConnection;return peers[e]=t,localStream&&localStream.getTracks().forEach(e=>t.addTrack(e,localStream)),t.onicecandidate=t=>{t.candidate&&socket.send(JSON.stringify({type:MESSAGE_TYPE_CANDIDATE,candidate:t.candidate,to:e,from:clientId}))},t.ontrack=t=>{console.log("ontrack from",e,t.streams[0]),ensureRemoteVideoElement(e);let r=remoteVideos[e].video;r.srcObject=t.streams[0];let a=document.querySelector('input[name="mainStreamSelector"]:checked');a&&a.value===e&&waitAndAttachToMain(e)},t}async function createOffer(e){let t=createPeer(e),r=await t.createOffer();await t.setLocalDescription(r),socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:r,to:e,from:clientId}))}function ensureRemoteVideoElement(e){if(remoteVideos[e])return remoteVideos[e];let t=document.createElement("div");t.className="video-wrapper",t.dataset.peerId=e,t.style.minWidth="160px";let r=document.createElement("video");r.autoplay=!0,r.playsInline=!0,r.id=`video-${e}`;let a=document.createElement("div");a.className="video-controls";let o=document.createElement("input");o.type="radio",o.name="mainStreamSelector",o.value=e,o.id=`radio-${e}`,o.addEventListener("change",()=>{o.checked&&waitAndAttachToMain(e)});let l=document.createElement("label");return l.htmlFor=`radio-${e}`,l.textContent=` Participant (${e?.substring(0,4)})`,a.appendChild(o),a.appendChild(l),t.appendChild(r),t.appendChild(a),document.getElementById("video-container").appendChild(t),remoteVideos[e]={wrapper:t,video:r},remoteVideos[e]}function waitAndAttachToMain(e,t=5e3){if(e===clientId){setMainScreenStream(localStream);return}let r=remoteVideos[e];r||(console.log("No video element for",e,"— creating placeholder."),ensureRemoteVideoElement(e));let a=remoteVideos[e].video;if(a.srcObject&&a.readyState>=2){setMainScreenStream(a.srcObject),console.log("Attached immediately main screen from",e);return}let o=!1,l=()=>{o||(o=!0,setMainScreenStream(a.srcObject),i(),console.log("Attached main screen after event from",e))},i=()=>{a.removeEventListener("loadedmetadata",l),a.removeEventListener("playing",l),clearTimeout(c)};a.addEventListener("loadedmetadata",l),a.addEventListener("playing",l);let c=setTimeout(()=>{o||(i(),console.warn(`Timeout waiting for video of ${e} to become ready.`))},t)}function isAudioMuted(){return document.querySelector(SELECTOR_SHARE_MICROPHONE).classList.contains(CLASS_MUTED)}async function startCamera(e){if(e.classList.contains(CLASS_SHARING)){e.classList.remove(CLASS_SHARING),stopSharing();return}try{localStream&&localStream.getTracks().forEach(e=>e.stop()),localStream=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0}),localVideo.srcObject=localStream,setMainScreenStream(localStream);let t=document.getElementById("radio-local");t&&(t.checked=!0),console.log("Local camera stream started."),e&&e.classList.add(CLASS_SHARING),isAudioMuted()&&muteLocalAudio(),await replaceOrAddTracksToPeers(localStream),socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),await renegotiateWithPeers()}catch(r){console.error("Failed to get local stream:",r),e&&e.classList.remove(CLASS_SHARING)}}async function shareScreen(e){if(e.classList.contains(CLASS_SHARING)){e.classList.remove(CLASS_SHARING),stopSharing();return}try{let t=await navigator.mediaDevices.getDisplayMedia({video:!0}),r=t.getVideoTracks()[0];localStream&&localStream.getVideoTracks().forEach(e=>e.stop()),localStream=t,localVideo.srcObject=localStream,setMainScreenStream(localStream);let a=document.getElementById("radio-local");a&&(a.checked=!0),console.log("Screen sharing started."),e&&e.classList.add(CLASS_SHARING),await replaceOrAddTracksToPeers(localStream),r.onended=async()=>{e&&e.classList.remove(CLASS_SHARING),await startCamera(e)},socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),await renegotiateWithPeers()}catch(o){console.error("Failed to share screen:",o),e&&e.classList.remove(CLASS_SHARING)}}async function replaceOrAddTracksToPeers(e){await Promise.all(Object.entries(peers).map(async([t,r])=>{for(let a of e.getTracks()){let o=r.getSenders().find(e=>e.track&&e.track.kind===a.kind);if(o)try{await o.replaceTrack(a)}catch(l){try{r.removeTrack(o)}catch(i){}r.addTrack(a,e)}else r.addTrack(a,e)}}))}async function renegotiateWithPeers(){for(let[e,t]of Object.entries(peers))try{let r=await t.createOffer();await t.setLocalDescription(r),socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:r,to:e,from:clientId}))}catch(a){console.warn("Renegotiate failed for",e,a)}}function sendChat(){let e=document.getElementById("chatInput").value;if(!e.trim())return;document.getElementById("chatInput").value="";let t={type:MESSAGE_TYPE_CHAT,text:e,from:clientId,messageId:generateMessageId()};putChat(t),socket.send(JSON.stringify(t))}function generateMessageId(){return crypto&&crypto.randomUUID?crypto.randomUUID():"msg-"+Date.now()+"-"+Math.floor(1e6*Math.random())}function promoteMyStream(e){if(e.classList.contains(CLASS_SHARING)){e.classList.remove(CLASS_SHARING),demoteMyStream();return}e.classList.add(CLASS_SHARING),socket.send(JSON.stringify({type:MESSAGE_TYPE_PROMOTE_STREAM,from:clientId}));let t=document.querySelector('input[name="mainStreamSelector"][value="local"]');if(!t){console.error("Please select a stream first");return}t.checked=!0;let r="local"===t.value?clientId:t.value;switchStreamTo(r)}function demoteMyStream(){socket.send(JSON.stringify({type:MESSAGE_TYPE_DEMOTE_STREAM,from:clientId}))}function promoteSelected(){if(!clientId){console.error("Client ID not ready");return}let e=document.querySelector('input[name="mainStreamSelector"]:checked');if(!e){console.error("Please select a stream first");return}let t="local"===e.value?clientId:e.value;switchStreamTo(t),socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId}))}async function replaceOrAddTracksToPeers(e){await Promise.all(Object.entries(peers).map(async([t,r])=>{for(let a of e.getTracks()){let o=r.getSenders().find(e=>e.track&&e.track.kind===a.kind);o?await o.replaceTrack(a):r.addTrack(a,e)}}))}async function stopSharing(){try{if(localStream){localStream.getVideoTracks().forEach(e=>e.stop());let e=localStream.getAudioTracks();localStream=e.length?new MediaStream(e):null}for(let[t,r]of(localVideo.srcObject=null,setMainScreenStream(null),console.log("Stopped sharing local video."),socket.send(JSON.stringify({type:MESSAGE_TYPE_STREAM_UPDATE,from:clientId})),socket.send(JSON.stringify({type:MESSAGE_TYPE_DEMOTE_STREAM,from:clientId})),socket.send(JSON.stringify({type:MESSAGE_TYPE_STOP_SHARING,from:clientId})),document.querySelector("#promoteBtn").classList.remove(CLASS_SHARING),Object.entries(peers))){let a=r.getSenders().filter(e=>e.track&&"video"===e.track.kind);a.forEach(e=>{try{r.removeTrack(e)}catch(t){}});try{let o=await r.createOffer();await r.setLocalDescription(o),socket.send(JSON.stringify({type:MESSAGE_TYPE_OFFER,offer:o,to:t,from:clientId}))}catch(l){console.warn("Renegotiate failed on stopSharing for",t,l)}}}catch(i){console.error("Failed to stop sharing:",i)}}function arrayBufferToBase64(e){let t="",r=new Uint8Array(e),a=r.byteLength;for(let o=0;o<a;o++)t+=String.fromCharCode(r[o]);return btoa(t)}function generateFileId(){return window.crypto?.randomUUID?crypto.randomUUID():"file-"+Date.now()+"-"+Math.floor(1e5*Math.random())}function getFileExtension(e){let t=e.split(".");return t.length>1?t.pop().toLowerCase():""}async function sendFile(){let e=document.getElementById("fileInput"),t=e.files[0];if(!t)return;let r=generateFileId(),a={type:MESSAGE_TYPE_FILE_META,fileId:r,name:t.name,extension:getFileExtension(t.name),size:t.size,mimeType:t.type,from:clientId,realtime:!0,complete:!1,chunkSize:16384};socket.send(JSON.stringify(a));let o=0;for(;o<t.size;){let l=t.slice(o,o+16384),i=await l.arrayBuffer(),c=arrayBufferToBase64(i);socket.send(JSON.stringify({type:MESSAGE_TYPE_FILE_CHUNK,fileId:r,name:t.name,extension:getFileExtension(t.name),from:clientId,offset:o,chunkSize:16384,data:c})),o+=16384}socket.send(JSON.stringify({type:MESSAGE_TYPE_FILE_COMPLETE,fileId:r,from:clientId})),clearFile();let n=document.getElementById("chat-box"),s=document.createElement("div"),d=URL.createObjectURL(t);t.type.startsWith("image/")?s.innerHTML=`<strong>You:</strong><br>
                        <div class="image-received">
                          <img src="${d}" alt="${t.name}">
                        </div>
                        <a href="${d}" download="${t.name}">📎 ${t.name}</a>`:s.innerHTML=`<strong>You:</strong> 
                         <a href="${d}" download="${t.name}">📎 ${t.name}</a>`,n.appendChild(s),setTimeout(function(){document.querySelector(".chat-box-container").scrollTop=document.querySelector(".chat-box-container").scrollHeight},100)}function selectFile(){document.getElementById("fileInput").click()}function previewFile(){let e=document.getElementById("fileInput"),t=document.querySelector(".send-file-preview");if(t.innerHTML="",0===e.files.length)return;let r=e.files[0],a=r.name,o=document.createElement("div");o.classList.add("flex","items-center","gap-2","bg-gray-700","text-white","p-2","rounded","flex-col");let l="";if(r.type.startsWith("image/")){let i=URL.createObjectURL(r);l=`<img src="${i}" alt="${a}" style="max-width:150px; max-height:150px; margin-bottom:4px; border-radius:4px;">`}o.innerHTML=`
        ${l}
        <div class="flex gap-2">
            <span>${a}</span>
            <button type="button" class="px-2 py-1 bg-red-600 rounded" onclick="clearFile()">❌</button>
            <button type="button" class="px-2 py-1 bg-green-600 rounded" onclick="sendFile()">✅</button>
        </div>
    `,t.appendChild(o),setTimeout(function(){document.querySelector(".chat-box-container").scrollTop=document.querySelector(".chat-box-container").scrollHeight},100)}function clearFile(){let e=document.getElementById("fileInput");e.value="",document.querySelector(".send-file-preview").innerHTML=""}const urlParams=new URLSearchParams(window.location.search);let roomId=urlParams.get("roomId")||"default";connectSocket(roomId);